<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mga Aralin - BalikWika</title>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link rel="stylesheet" href="{{ url_for('teacher.static', filename='mga_aralin.css') }}" />
</head>
<body>
  <div class="sidebar">
    <div class="logo">
      <img src="/static/balikwika.png" alt="BalikWika Logo" />
    </div>
    <a href="{{ url_for('teacher.teacher_dashboard') }}" class="nav-item">Dashboard</a>
    <a href="{{ url_for('teacher.mga_aralin') }}" class="nav-item active">Mga aralin</a>
    <a href="{{ url_for('teacher.mga_pagsusulit') }}" class="nav-item">Pagsusulit</a>
    <a href="{{ url_for('teacher.profile') }}" class="nav-item">Aking profile</a>
    <a href="#" class="nav-item" id="logout-btn">Mag log-out</a>
  </div>

  <div class="main-content">
    <div class="header">
      <h1 class="page-title">Mga Aralin</h1>
      <div class="search-container">
        <i class="fas fa-search search-icon"></i>
        <input type="text" class="search-input" placeholder="Maghanap ng paksa..." id="searchInput" />
      </div>
    </div>

    <div class="subjects-grid" id="subjectsGrid">
      <div class="subject-card pangngalan" onclick="openSubjectModal('Pangngalan')">
        <div class="subject-icon"><i class="fas fa-cube"></i></div>
        <h3 class="subject-title">Pangngalan</h3>
        <p class="subject-description">Mga salitang tumutukoy sa mga tao, hayop, bagay, lugar, at ideya.</p>
        <span class="lesson-count" id="pangngulanCount">0 mga aralin</span>
      </div>

      <div class="subject-card pandiwa" onclick="openSubjectModal('Pandiwa')">
        <div class="subject-icon"><i class="fas fa-running"></i></div>
        <h3 class="subject-title">Pandiwa</h3>
        <p class="subject-description">Mga salitang nagsasaad ng kilos, galaw, o estado ng paksa.</p>
        <span class="lesson-count" id="pandiwaCount">0 mga aralin</span>
      </div>

      <div class="subject-card pang-uri" onclick="openSubjectModal('Pang-uri')">
        <div class="subject-icon"><i class="fas fa-palette"></i></div>
        <h3 class="subject-title">Pang-uri</h3>
        <p class="subject-description">Mga salitang naglalarawan sa pangngalan at panghalip.</p>
        <span class="lesson-count" id="panguriCount">0 mga aralin</span>
      </div>

      <div class="subject-card panghalip" onclick="openSubjectModal('Panghalip')">
        <div class="subject-icon"><i class="fas fa-user-friends"></i></div>
        <h3 class="subject-title">Panghalip</h3>
        <p class="subject-description">Mga salitang pumapalit sa pangngalan upang iwasang pauulitin.</p>
        <span class="lesson-count" id="panghalipCount">0 mga aralin</span>
      </div>
    </div>
  </div>

  <!-- Subject Lessons Modal -->
  <div id="subjectModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="subjectModalTitle">Mga Aralin</h2>
        <p class="modal-subtitle" id="subjectModalSubtitle">Piliin ang aralin na nais ninyong tingnan</p>
        <span class="modal-close" onclick="closeSubjectModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="lessons-list" id="lessonsList"></div>
        <div class="empty-state" id="emptyLessons" style="display: none;">
          <i class="fas fa-book-open"></i>
          <h3>Walang mga aralin pa</h3>
          <p>Mag-antay ng mga bagong aralin mula sa inyong mga guro sa paksang ito.</p>
        </div>
        <div style="text-align: right; margin-top: 20px;">
          <button onclick="openAddLessonModal()" class="add-lesson-btn">
            <i class="fas fa-plus"></i> Magdagdag ng Aralin
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Lesson Modal -->
  <div id="addLessonModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Magdagdag ng Aralin</h2>
        <span class="modal-close" onclick="closeAddLessonModal()">&times;</span>
      </div>
      <div class="modal-body">
        <label for="lessonTitle">Pamagat ng Aralin:</label>
        <input type="text" id="lessonTitle" placeholder="Ilagay ang pamagat" />
        <label for="lessonContent">Nilalaman ng Aralin:</label>
        <textarea id="lessonContentInput" rows="6" placeholder="Ilagay ang nilalaman..."></textarea>
      </div>
      <div class="modal-body-buttons">
        <button class="cancel-btn" onclick="closeAddLessonModal()">Kanselahin</button>
        <button class="add-btn" onclick="addNewLesson()">Idagdag</button>
      </div>
    </div>
  </div>

  <!-- Lesson Content Modal -->
  <div id="lessonModal" class="modal lesson-content-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="lessonModalTitle">Lesson Title</h2>
        <span class="modal-close" onclick="closeLessonModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="lesson-content-text" id="lessonContent">Lesson content will appear here...</div>
      </div>
      <div class="lesson-content-footer">
        <div class="teacher-info">
          <div class="teacher-avatar" id="lessonTeacherAvatar">T</div>
          <div>
            <div style="font-weight: 600; color: #333;" id="lessonTeacherName">Teacher Name</div>
            <div style="font-size: 12px; color: #666;" id="lessonDate">Date</div>
          </div>
        </div>
      </div>
    </div>
  </div>

   <!-- Logout Modal -->
<div id="logoutModal" class="logout-modal">
    <div class="logout-modal-content">
        <span class="logout-close" id="closeModal"></span>
        <div class="logout-modal-header">
            <div class="logout-modal-icon">⚠️</div>
            <h2 class="logout-modal-title">Confirm Logout</h2>
        </div>
        <div class="logout-modal-body">
            <p class="logout-modal-message">
                Are you sure you want to logout? You will be redirected to the login page.
            </p>
        </div>
        <div class="logout-modal-actions">
            <button class="logout-btn logout-btn-cancel" id="cancelLogout">Cancel</button>
            <a href="{{ url_for('logout') }}" class="logout-btn logout-btn-confirm">Logout</a>
        </div>
    </div>
</div>

  <script>
    const lessonsData = {
      'Pangngalan': [],
      'Pandiwa': [],
      'Pang-uri': [],
      'Panghalip': []
    };

    let currentSubject = '';

    function updateLessonCounts() {
      document.getElementById('pangngulanCount').textContent = `${lessonsData['Pangngalan'].length} mga aralin`;
      document.getElementById('pandiwaCount').textContent = `${lessonsData['Pandiwa'].length} mga aralin`;
      document.getElementById('panguriCount').textContent = `${lessonsData['Pang-uri'].length} mga aralin`;
      document.getElementById('panghalipCount').textContent = `${lessonsData['Panghalip'].length} mga aralin`;
    }

    function openSubjectModal(subject) {
      currentSubject = subject;
      document.getElementById('subjectModalTitle').textContent = `Mga Aralin sa ${subject}`;
      renderLessons();
      document.getElementById('subjectModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    function closeSubjectModal() {
      document.getElementById('subjectModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    function openAddLessonModal() {
      document.getElementById('addLessonModal').style.display = 'block';
    }

    function closeAddLessonModal() {
      document.getElementById('addLessonModal').style.display = 'none';
      document.getElementById('lessonTitle').value = '';
      document.getElementById('lessonContentInput').value = '';
    }

    function addNewLesson() {
      const title = document.getElementById('lessonTitle').value.trim();
      const content = document.getElementById('lessonContentInput').value.trim();
      const subject = currentSubject;

      if (!title || !content) {
        alert('Pakikompletuhin ang lahat ng field.');
        return;
      }

      // Create FormData for proper form submission
      const formData = new FormData();
      formData.append('title', title);
      formData.append('content', content);
      formData.append('subject', subject);

      fetch('/teacher/add_lesson', {  // Fixed: Add the blueprint prefix
        method: 'POST',
        body: formData  // Use FormData instead of URL encoding
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert("Naidagdag na ang aralin.");
          closeAddLessonModal();
          
          // Reload lessons from server to get the complete data
          loadLessons();
        } else {
          alert(data.message || "May error sa pagdagdag ng aralin.");
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert("May error sa pagdagdag ng aralin.");
      });
    }

    function renderLessons() {
      const lessonsList = document.getElementById('lessonsList');
      const emptyState = document.getElementById('emptyLessons');
      const subject = currentSubject;

      lessonsList.innerHTML = '';

      if (lessonsData[subject] && lessonsData[subject].length > 0) {
        emptyState.style.display = 'none';
        lessonsList.style.display = 'grid';

        lessonsData[subject].forEach(lesson => {
          const lessonItem = document.createElement('div');
          lessonItem.className = 'lesson-item';
          lessonItem.innerHTML = `
            <div class="lesson-item-title">${lesson.title}</div>
            <div class="lesson-item-preview">${lesson.content.substring(0, 100)}...</div>
            <div class="lesson-item-meta">
              <span><i class="fas fa-user"></i> ${lesson.teacher}</span>
              <span><i class="fas fa-calendar"></i> ${lesson.date}</span>
            </div>`;
          lessonItem.onclick = () => openLessonModal(lesson);
          lessonsList.appendChild(lessonItem);
        });
      } else {
        emptyState.style.display = 'block';
        lessonsList.style.display = 'none';
      }
    }

    function openLessonModal(lesson) {
      document.getElementById('lessonModalTitle').textContent = lesson.title;
      document.getElementById('lessonContent').textContent = lesson.content;
      document.getElementById('lessonTeacherAvatar').textContent = lesson.teacher[0] || 'T';
      document.getElementById('lessonTeacherName').textContent = lesson.teacher;
      document.getElementById('lessonDate').textContent = lesson.date;
      closeSubjectModal();
      document.getElementById('lessonModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    function closeLessonModal() {
      document.getElementById('lessonModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    function loadLessons() {
      fetch('/teacher/get_lessons')
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            console.error('Error loading lessons:', data.error);
            alert('Error loading lessons: ' + data.error);
            return;
          }
          
          // Clear existing data and update with fresh data from server
          for (let subject in lessonsData) {
            lessonsData[subject] = [];
          }
          Object.assign(lessonsData, data);
          updateLessonCounts();
          
          // If a subject modal is open, refresh its content
          if (currentSubject && document.getElementById('subjectModal').style.display === 'block') {
            renderLessons();
          }

           /// Navigation handler - Fixed version
function handleNavigation() {
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
            // Skip the active class removal for logout button  
            if (this.id === 'logout-btn') {
                return; // Don't modify active states for logout
            }
            
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            
            // Don't prevent default for actual links
            if (this.getAttribute('href') === '#') {
                e.preventDefault();
            } else {
                // Add active class to clicked item
                this.classList.add('active');
            }
        });
    });
}


          // Animate cards on initial load only if they haven't been animated yet
          const cards = document.querySelectorAll('.subject-card');
          const firstCard = cards[0];
          if (firstCard && firstCard.style.opacity !== '1') {
            cards.forEach((card, index) => {
              card.style.opacity = '0';
              card.style.transform = 'translateY(20px)';
              setTimeout(() => {
                card.style.transition = 'all 0.6s ease';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
              }, index * 100);
            });
          }
        })
        .catch(err => {
          console.error("Failed to load lessons", err);
          alert('Failed to load lessons. Please check your connection.');
        });
    }

    // Load lessons when page loads
    document.addEventListener('DOMContentLoaded', () => {
      loadLessons();
    });

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', function () {
      const searchTerm = this.value.toLowerCase();
      document.querySelectorAll('.subject-card').forEach(card => {
        const title = card.querySelector('.subject-title').textContent.toLowerCase();
        const description = card.querySelector('.subject-description').textContent.toLowerCase();
        card.style.display = title.includes(searchTerm) || description.includes(searchTerm) ? 'block' : 'none';
      });
    });

    // Modal close handlers
    window.onclick = function (event) {
      if (event.target === document.getElementById('subjectModal')) closeSubjectModal();
      if (event.target === document.getElementById('lessonModal')) closeLessonModal();
      if (event.target === document.getElementById('addLessonModal')) closeAddLessonModal();
    };

    document.addEventListener('keydown', function (event) {
      if (event.key === 'Escape') {
        closeSubjectModal();
        closeLessonModal();
        closeAddLessonModal();
      }
    });

    
// Modal functionality
const modal = document.getElementById('logoutModal');
const logoutBtn = document.getElementById('logout-btn');
const closeModal = document.getElementById('closeModal');
const cancelLogout = document.getElementById('cancelLogout');

// Open modal when logout button is clicked
logoutBtn.addEventListener('click', function(e) {
    e.preventDefault();
    modal.style.display = 'block';
});

// Close modal when X is clicked
closeModal.addEventListener('click', function() {
    modal.style.display = 'none';
});

// Close modal when Cancel is clicked
cancelLogout.addEventListener('click', function() {
    modal.style.display = 'none';
});

// Close modal when clicking outside of it
window.addEventListener('click', function(event) {
    if (event.target == modal) {
        modal.style.display = 'none';
    }
});

  </script>
</body>
</html>
